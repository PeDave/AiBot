@page "/"
@using BitgetApi.Dashboard.Web.Services
@using BitgetApi.Dashboard.Web.Data.Models
@inject PriceTrackerService PriceTracker
@inject OrderBookService OrderBook
@inject TradeStreamService TradeStream
@inject HistoricalDataService HistoricalData
@implements IAsyncDisposable

<PageTitle>Bitget Live Dashboard</PageTitle>

<div class="dashboard">
    <h1>BITGET LIVE MARKET DASHBOARD v1.0</h1>
    
    <div class="status-bar">
        <span class="status connected">‚óè Connected</span>
        <span class="uptime">Uptime: @uptime.ToString(@"hh\:mm\:ss")</span>
        <span class="messages">Messages: @messageCount</span>
    </div>
    
    <!-- SYMBOL SELECTOR & CHART -->
    <div class="dashboard-grid">
        <div class="symbol-selector-panel">
            <SymbolSelector OnSymbolSelected="HandleSymbolSelected" />
        </div>
        
        <div class="chart-panel">
            <PriceChart Symbol="@selectedSymbol" 
                        Interval="@selectedInterval" 
                        Candles="@candles"
                        OnIntervalChange="HandleIntervalChange" />
        </div>
    </div>
    
    <!-- PRICES -->
    <div class="prices-container">
        @foreach (var symbol in symbols)
        {
            var price = PriceTracker.GetPrice(symbol);
            <PriceCard Symbol="@symbol" Price="@price" />
        }
    </div>
    
    <!-- ORDER BOOK -->
    <div class="orderbook-container">
        <OrderBook Symbol="@selectedSymbol" OrderBookData="@OrderBook.GetOrderBook(selectedSymbol)" />
    </div>
    
    <!-- RECENT TRADES -->
    <div class="trades-container">
        <RecentTrades Symbol="@selectedSymbol" Trades="@TradeStream.GetRecentTrades(selectedSymbol)" />
    </div>
    
    <!-- STATISTICS -->
    <div class="stats-container">
        <Statistics Uptime="@uptime" MessageCount="@messageCount" />
    </div>
</div>

@code {
    private readonly string[] symbols = { "BTCUSDT", "ETHUSDT", "XRPUSDT" };
    private string selectedSymbol = "BTCUSDT";
    private string selectedInterval = "1H";
    private string productType = "SPOT";
    private List<CandleData> candles = new();
    private TimeSpan uptime;
    private int messageCount;
    private DateTime startTime;
    private System.Threading.Timer? updateTimer;
    
    protected override async Task OnInitializedAsync()
    {
        startTime = DateTime.Now;
        
        // Event handlers
        PriceTracker.OnPriceUpdated += OnDataUpdated;
        OrderBook.OnOrderBookUpdated += OnDataUpdated;
        TradeStream.OnTradeReceived += OnDataUpdated;
        
        // Subscribe to symbols
        foreach (var symbol in symbols)
        {
            await PriceTracker.SubscribeAsync(symbol);
        }
        
        await OrderBook.SubscribeAsync(selectedSymbol);
        await TradeStream.SubscribeAsync(selectedSymbol);
        
        // Load initial chart data
        await LoadCandlesAsync();
        
        // Update timer
        updateTimer = new System.Threading.Timer(_ =>
        {
            uptime = DateTime.Now - startTime;
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }
    
    private async Task HandleSymbolSelected((string symbol, string productType) selection)
    {
        selectedSymbol = selection.symbol;
        productType = selection.productType;
        await LoadCandlesAsync();
        
        // Subscribe to WebSocket for selected symbol
        await PriceTracker.SubscribeAsync(selectedSymbol);
        await OrderBook.SubscribeAsync(selectedSymbol);
        await TradeStream.SubscribeAsync(selectedSymbol);
    }

    private async Task HandleIntervalChange(string interval)
    {
        selectedInterval = interval;
        await LoadCandlesAsync();
    }

    private async Task LoadCandlesAsync()
    {
        try
        {
            candles = await HistoricalData.GetOrFetchCandlesAsync(
                selectedSymbol, 
                selectedInterval, 
                productType);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading candles: {ex.Message}");
        }
    }
    
    private void OnDataUpdated()
    {
        messageCount++;
        InvokeAsync(StateHasChanged);
    }
    
    public async ValueTask DisposeAsync()
    {
        PriceTracker.OnPriceUpdated -= OnDataUpdated;
        OrderBook.OnOrderBookUpdated -= OnDataUpdated;
        TradeStream.OnTradeReceived -= OnDataUpdated;
        
        updateTimer?.Dispose();
    }
}
